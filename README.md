# Домашнее задание к занятию «Резервное копирование баз данных»

---

### Задание 1. Резервное копирование

### Кейс
Финансовая компания решила увеличить надёжность работы баз данных и их резервного копирования. 

Необходимо описать, какие варианты резервного копирования подходят в случаях: 

1.1. Необходимо восстанавливать данные в полном объёме за предыдущий день.

1.2. Необходимо восстанавливать данные за час до предполагаемой поломки.

1.3.* Возможен ли кейс, когда при поломке базы происходило моментальное переключение на работающую или починенную базу данных.

*Приведите ответ в свободной форме.*

---

1.1. Для этой задачи используется стратегия ежедневного полного резервного копирования (Full Backup). Для оптимизации можно использовать схему с еженедельным полным и ежедневным дифференциальным бэкапом. Важным аспектом является хранение резервных копий на физически отдельном сервере или в облачном хранилище, чтобы избежать их потери вместе с основным сервером.

1.2. Эта задача решается с помощью восстановления на определённый момент времени (Point-in-Time Recovery, PITR). Стратегия основана на комбинации периодических полных бэкапов и непрерывного архивирования журналов транзакций (WAL в PostgreSQL, binlog в MySQL).

1.3.* Да, это стандартный сценарий обеспечения высокой доступности (High Availability), который реализуется через репликацию. В этой архитектуре используется кластер primary/standby с автоматическим переключением (failover), управляемым специализированным программным обеспечением. Цели доступности определяются метриками RTO и RPO. Нулевая потеря данных (RPO=0) требует синхронной репликации.Репликация не заменяет резервное копирование, так как она немедленно скопирует и логические ошибки (например, DROP TABLE).

### Задание 2. PostgreSQL

2.1. С помощью официальной документации приведите пример команды резервирования данных и восстановления БД (pgdump/pgrestore).

2.1.* Возможно ли автоматизировать этот процесс? Если да, то как?

*Приведите ответ в свободной форме.*

---

2.1. Команды для резервного копирования:
```bash
# 1. Бэкап базы данных 
pg_dump -U myuser -Fc -f my_database.dump my_database

# 2. Бэкап глобальных объектов (роли, права доступа)
pg_dumpall -U myuser --globals-only > globals.sql
```

Команда для восстановления:

```bash
# 1. Сначала восстанавливаем глобальные объекты (роли, права)
# Это необходимо, чтобы при восстановлении базы данных уже существовали нужные владельцы
psql -U myuser -d postgres -f globals.sql

# 2. Затем восстанавливаем структуру и данные базы с предварительной очисткой
# (флаг -C создаст базу данных, если она не существует)
pg_restore -U myuser -C -d postgres --clean my_database.dump
```

2.1.*
Да, автоматизация обязательна. Она включает:
Инструменты: Планировщик cron или специализированные утилиты, такие как pgBackRest.
Процесс: Автоматизация должна включать настройку политики хранения (retention), а также регулярное тестовое восстановление на отдельном сервере для проверки целостности бэкапов.


### Задание 3. MySQL

3.1. С помощью официальной документации приведите пример команды инкрементного резервного копирования базы данных MySQL. 

3.1.* В каких случаях использование реплики будет давать преимущество по сравнению с обычным резервным копированием?

*Приведите ответ в свободной форме.*

---

3.1. Для этой задачи стандартным для Community-версий инструментом является Percona XtraBackup. Процесс состоит из создания бэкапа и его обязательной подготовки.

```bash
# 1. Создание полного бэкапа
xtrabackup --backup --target-dir=/data/backups/base

# 2. Создание инкрементального бэкапа
xtrabackup --backup --target-dir=/data/backups/inc1 --incremental-basedir=/data/backups/base

# 3. Подготовка бэкапа к восстановлению (обязательный многоэтапный процесс)
# Сначала подготавливается полная копия, применяются логи
xtrabackup --prepare --apply-log-only --target-dir=/data/backups/base
# Затем "накатывается" инкрементальная копия
xtrabackup --prepare --apply-log-only --target-dir=/data/backups/base --incremental-dir=/data/backups/inc1
# откат незавершенных транзакций. Бэкап готов к восстановлению.
xtrabackup --prepare --target-dir=/data/backups/base
```
3.1.*  Репликация даёт ключевые преимущества в следующих сценариях:
Высокая доступность (HA): Обеспечивает низкое время восстановления (RTO) за счёт мгновенного переключения на резервный сервер.
Масштабирование нагрузки на чтение (Read Scaling): Позволяет распределять SELECT-запросы между репликами.
Изоляция нагрузки: Ресурсоёмкие операции (аналитика, создание бэкапов) можно выполнять на реплике.
Ключевым недостатком реплики является то, что она копирует и человеческие ошибки, что делает наличие классических бэкапов абсолютно обязательным.